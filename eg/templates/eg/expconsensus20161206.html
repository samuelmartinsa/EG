<!doctype html>

<html><head>
		<title>Estimation game</title>
		<meta charset="utf-8">
    
		
		<link rel=stylesheet href="../../static/css/eg.css" type="text/css">
    
	  <script src="../../static/jquery-min.js" type="text/javascript"></script>
		<script src="../../static/gen_validatorv4.js" type="text/javascript"> </script>
		<script src="../../static/json3.js"></script>
		
		<!-- TIMER (Knob)-->
		<link href="../../static/jQuery-Knob-master/knob.css" media="screen" rel="stylesheet" type="text/css"/>
		<script src="../../static/jQuery-Knob-master/js/jquery.knob.js"></script>
		<script src="../../static/jQuery-Knob-master/myknob.js" type="text/javascript"></script>
    
		<link href="../../static/zoomeg/style.css" rel="stylesheet" type="text/css"/>
    <script src="../../static/zoomeg/cnx.js" type="text/javascript"></script>
    <script src="../../Scripts/swfobject_modified.js" type="text/javascript"></script>
    <script src="../../static/zoomeg/zoom.js" type="text/javascript"></script>
		<script type="text/javascript">			
			//var listOfEstimations = [];
			var playMode="{{ playMode }}"
			var minDecisionValue="{{EGParameters['minDecisionValue']}}"
			var maxDecisionValue="{{EGParameters['maxDecisionValue']}}"
			var imageType="{{EGParameters['imageType']}}"
			var position_or_value="{{EGParameters['position_or_value']}}"
			var columnNumber=parseInt("{{ columnNumber }}",10)
			var prevChoice = [];
			var prevGame=-1;
			var tab_roundduration=new Array();
			var roundType = "{{ roundType }}";
			tab_roundduration['LONE']="{{EGParameters['loneRoundDuration']}}" 
			tab_roundduration['SOCIAL']="{{EGParameters['socialRoundDuration']}}"
			var game = "{{ game }}";
			var imgsize = "{{ EGParameters['imgsize'] }}";
			var displayedimgsize="{{ EGParameters['displayedimgsize'] }}"
			var graduationRuleWidth="{{ EGParameters['graduationRuleWidth'] }}"
			var graduationRuleWidthZoom="{{ EGParameters['graduationRuleWidthZoom'] }}"
			var visibleimgpartsize=33/100;
			var coord_mouse=0;
			// 24/03/2016 added to empty the decision field after an (ajax jquery) post in social continuous rounds
			var ajaxsocial=false;
			<!-- return date-time with dd-mm-yyyy-HH-mn-sec format for user's display -->
			
			function stringdate()
			{	var currentdate = new Date();
				var datetime = currentdate.getDay() + "-"+currentdate.getMonth() + "-" + currentdate.getFullYear() + "-" + currentdate.getHours() + "-"	+ currentdate.getMinutes() + "-" + currentdate.getSeconds();
				return datetime;
			}
			
			/* transforms styles #color values to percent displayed as #decision id form values */
			function refreshSwatch() 
			{	var red = $( "#red" ).slider( "value" );
				var green = $( "#green" ).slider( "value" );
				var blue = $( "#blue" ).slider( "value" );
				var perc = parseFloat(red)/10;
				var perc2 = parseFloat(green/10);
				var perc3 = parseFloat(blue/10);			
				$( "#decision0" ).val(perc);
				$( "#decision1" ).val(perc2);
				$( "#decision2" ).val(perc3);
			}
			
			function transformStringListRoundValues2Array(prevRoundHTML)
			{	try
 				{ tabstring=prevRoundHTML
					while(tabstring.indexOf(" ")!=-1)
					{ tabstring=tabstring.substr(0,tabstring.indexOf(" "))+tabstring.substr(tabstring.indexOf(" ")+1,tabstring.length)
					}
					tabstring=tabstring.substr(2,tabstring.length)
					tabstring=tabstring.substr(0,tabstring.length-2)
					tablist=tabstring.split("],[")
					var listRoundValues=Array()
					for(i=0;i<tablist.length;i++)
					{ listRoundValues[i]=tablist[i].split(",")
					}
				}
				catch(e)
				{	alert('catch transformStringListRoundValues2Array')
				}
				return listRoundValues
			}
			
			function isDifferentFromPreviousEstimations(prevRoundHTML,listRoundValues)
			{ return prevRoundHTML!=listRoundValues;
			}
			
			function createRoundImages(canvas,listRoundValues,prevChoice,distinct,xMax,imgRuleHeight,graduationRuleWidth,zoom,xLabelFormat,graduationStep1,graduationStep2,estimationPointSize) 
			{ //alert('appel createRoundImages '+listRoundValues);
				zoomedRuleImgWidth=graduationRuleWidth*zoom
				canvas.width=zoomedRuleImgWidth
				canvas.height=imgRuleHeight
				ratio=(graduationRuleWidth/xMax)*zoom
				xAxisPos=imgRuleHeight/2
				imgNumber_of_one_round = 0
				// The choice of WorkerId must be printed and not hidden with the choice of an other worker : printed after others players prints 
				xWorkerId=xMax+1
				for(numEvaluatedImg=0;numEvaluatedImg<listRoundValues.length;numEvaluatedImg++)
				{	oneEvaluatedImg=listRoundValues[numEvaluatedImg]
					imgNumber_of_one_round = imgNumber_of_one_round + 1
					draw = canvas.getContext("2d");
					draw.fillStyle = "rgb(255,255,255)";
					draw.fillRect(0,0,zoomedRuleImgWidth,imgRuleHeight)
					draw.font = 'bold 8pt Courier';
					// draw = ImageDraw.Draw(img_prevround)
					// x axis
					draw.fillStyle = "rgb(0,0,0)"
					draw.fillRect(0,xAxisPos,zoomedRuleImgWidth,1)
					for(x=0;x<parseInt(xMax);x++)
					{	//draw.fillRect(x*ratio,xAxisPos-2,1,2)
						if(x%graduationStep1 == 0)
						{ draw.fillRect(x*ratio-1,xAxisPos-4,2,4)
						}
						if(x%graduationStep2 == 0)
						{ draw.fillRect(x*ratio-1,xAxisPos-8,2,8)
							textSize=draw.measureText(String(x))
							textWidth = textSize.width
							draw.fillText(String(x),x*ratio-textWidth/2, xAxisPos+15)
							//, xLabelFormat.format(x),fill=(0,0,0), font=font);
						}
					}// round responses values over the x axis
					for(j in oneEvaluatedImg)
					{ oneValue=oneEvaluatedImg[j]
						if(oneValue!=0)
						{ x = oneValue*ratio;	
							centerX = x;centerY = 10;radius=2;
							draw.beginPath();
							draw.arc(centerX, centerY, radius, 0, 2*Math.PI, false);
							draw.fillStyle = "rgb(0,0,255)";
							draw.fill();
							draw.lineWidth = 5;
							draw.strokeStyle = 'rgb(0,0,255)';
							draw.stroke();
						}
					}
					//user choice in red
					centerX = prevChoice[numEvaluatedImg]*ratio; centerY = 10;radius=2
					draw.beginPath();
					draw.arc(centerX, centerY, radius, 0, 2*Math.PI, false)
					draw.fillStyle = "rgb(255,0,0)"
					draw.fill();
					draw.lineWidth = 5;
					draw.strokeStyle = 'rgb(255,0,0)';
					draw.stroke();
					document.getElementById("img_prevround"+imgNumber_of_one_round+distinct).src = canvas.toDataURL();
				}
			}
						
			(function($)
			{ $.extend({ playSound: function() { return $("<embed src='"+arguments[0]+"' hidden='true' autostart='true' loop='false' class='playSound'>").appendTo('body');}});
			})(jQuery);
			
			// Subject info, including condition and counterbalance codes.		
			var remainingTimeServer;
			var timeleft;
			var updatecallnumber=0;
			var getfrenquence=5;
			var debug_isGetSend;
			
			$(document).ready( function()
			{	var urlParam = searchToObject();
				if(	window.location.href.indexOf("expconsensus") == -1 
						|| window.location.href.indexOf("hitId") == -1 || urlParam["hitId"] != "{{ hitId }}" 
						|| window.location.href.indexOf("assignmentId") == -1 || urlParam["assignmentId"] != "{{ assignmentId }}" 
						|| window.location.href.indexOf("workerId") == -1 || urlParam["workerId"] != "{{ workerId }}" 
						|| window.location.href.indexOf("sessionId") == -1 || urlParam["sessionId"] != "{{ sessionId }}"
					)
				{ window.location = '/eg/expconsensus?hitId={{ hitId }}&assignmentId={{ assignmentId }}&workerId={{ workerId }}&sessionId={{sessionId}}';
				}
				// transforms the document url search string to an array of pair name/value  
				function searchToObject() 
				{	var pairs = window.location.search.substring(1).split("&");
					var obj = {};
					var pair;
					var i;
					for ( i in pairs ) 
					{ if ( pairs[i] === "" ) continue;
						pair = pairs[i].split("=");
						obj[ decodeURIComponent( pair[0] ) ] = decodeURIComponent( pair[1] );
					}
					return obj;
				}
				//for robot : assignmentId='{{ assignmentId }}'
				var assignmentId = "{{ assignmentId }}";
				var workerId = "{{ workerId }}";
				var hitId = "{{ hitId }}";
				var sessionId = "{{ sessionId }}";
				var round = "{{ round }}";
				game = "{{ game }}";
				document.round = "{{ round }}";
				var prevRoundHTML = "{{ prevRoundHTML }}";			
				var status = "{{ status }}";
				if(status=="GAMESET_OVER")
				{	window.location.href="/eg/debriefing?hitId="+hitId+"&assignmentId="+assignmentId+"&workerId="+workerId+"&sessionId="+sessionId;
				}
				var missingChoices = "{{ missingChoices }}";
				var question = "{{ question }}";
				var sound = "{{ sound }}";
				var staticPath = "{{ staticPath }}";
				roundType = "{{ roundType }}";
				/*var maxDecisionValue="{{EGParameters['maxDecisionValue']}}"
				var imageType="{{EGParameters['imageType']}}"
				var playMode="{{EGParameters['playMode']}}"
				var position_or_value="{{EGParameters['position_or_value']}}"*/
				var reward;
				if(sound==1)
				{ var audioElement = document.createElement('audio');
					audioElement.setAttribute('src', staticPath+'pic/sound.mp3');
					audioElement.play();
				}
				if(roundType=='LONE')   
				{ remainingTimeServer="{{EGParameters['loneRoundDuration']}}"
					reward=parseInt("{{EGParameters['loneMaxReward']}}",10)
					$("#prevRoundSentence1").html('<img src="'+staticPath+'"pic/spacer.gif" width="1" height="60">')
					for(var i=0; i<=columnNumber;i++)
					{	$("#div_img_prevround"+(i+1)).hide()
					}
					// td borders and content in lone rounds
					td_list=$("[id^='td_']");
					for(k=0;k<td_list.length;k++)
					{ td_list.eq(k).css({"border-style":"none"});
					}

				}
				else if(roundType=='SOCIAL')   
				{ remainingTimeServer="{{EGParameters['socialRoundDuration']}}"
					reward=parseInt("{{EGParameters['socialMaxReward']}}",10)
					for(var i=0; i<=columnNumber;i++)
					{	$("#div_img_prevround"+(i+1)).show()
					}
				}
				roundsentencebutton="<span class='black18'>Game "+game+"/{{EGParameters['numGames']}} - Round "+round;
				if(playMode=='discrete')
				{ roundsentencebutton=roundsentencebutton+" (You are playing for "+reward+" points)"
				}
				roundsentencebutton=roundsentencebutton+"</span>"
				$("#round").html(roundsentencebutton); 
				timeleft=remainingTimeServer
				document.getElementById('debug_timeleft').value=timeleft;				
				document.getElementById('debug_remainingTimeServer').value=remainingTimeServer;
				
				question=question.split(",");
				
				if(status=="CHOICE_TO_BE_MADE")
				{	$("#waiting").hide();
				}
				else if(status=="CHOICE_MADE")
				{	$("#playing").hide();
				}
				
				/*var imageurl = String("{{ imageurl }}");
				imageurl = imageurl.replace('[','');
				imageurl = imageurl.replace(']','');
				imageurl = imageurl.replace('\'','');
				imageurl = imageurl.replace(/'/g,'');								
				imageurl=imageurl.split(",");
				imageurl[0] = imageurl[0].replace(/'/g,'');*/					

				var canvasImageToEvaluate = document.getElementById('canvasImageToEvaluate');
				var context = canvasImageToEvaluate.getContext('2d');
				
				var imageObj = new Image();
				imageObj.src = document.getElementById('gameset_pic_name').src;
				imageObj.onload = function() 
				{ for(i=0;i<columnNumber;i++)
					{// draw cropped image
						var sourceX = imgsize*i;
						var sourceY = imgsize*(parseInt(game,10)-1);
						var sourceWidth = imgsize;
						var sourceHeight = imgsize;
						var destWidth = displayedimgsize;
						var destHeight = displayedimgsize;
						var destX = 0;
						var destY = 0;
						context.drawImage(imageObj, sourceX, sourceY, sourceWidth, sourceHeight, destX, destY, destWidth, destHeight);
						context.stroke();
						if(position_or_value=='position')
						{	context.beginPath();
							context.fillStyle = "rgb(127,127,127)";
							//leftWidth=coord_mouse.x;
							context.fillRect(0,0,(displayedimgsize*visibleimgpartsize),displayedimgsize);
							context.fillRect(displayedimgsize-(displayedimgsize*visibleimgpartsize),destY,displayedimgsize,displayedimgsize);
							context.stroke();
						}
						document.getElementById('image'+(i+1)).src=canvasImageToEvaluate.toDataURL();
					}
				};

				if($("#decision0").length)
				{ $("#decision0").focus();
				}
				// Launch a listener checking if a choice has been made or if the round is over
				var int = self.setInterval(function() 
				{	update(assignmentId,workerId,hitId,sessionId);
				}, 1000);

			}); // end of $(document).ready

			function update(assignmentId,workerId,hitId,sessionId)
			{ // get is made one time (updatecallnumber==0) and every getfrenquence while timeleft > 10 sec
				if(position_or_value=='value')// 24/03/2016 added to empty the decision field after an an ajax jquery post in social continuous rounds
				{	if(ajaxsocial)
					{ $("#decision0").val('')
						ajaxsocial=false
					}
				}
				if(updatecallnumber>0 && updatecallnumber<getfrenquence && timeleft>10 && timeleft<1000 && playMode=='discrete')
				{ timeleft--; // update is called every 1000ms : timeleft is approximatively 1s more
					var totalTime = timeleft;	    					    				
					var timeleftnotbig = timeleft;
					if(timeleftnotbig>200)
					{	timeleftnotbig = 0;
					}
					mydial(totalTime,timeleftnotbig);
					// debug
					document.getElementById('debug_timeleft').value=timeleft;				
					document.getElementById('debug_updatecallnumber').value=updatecallnumber;
					debug_isGetSend='NO';				
					document.getElementById('debug_isGetSend').value=debug_isGetSend;				
					document.getElementById('debug_remainingTimeServer').value=remainingTimeServer;
					// end debug				
					updatecallnumber++;
				
				}
				else
				{ var url = "/eg/expconsensus".concat("?hitId=",hitId,"&assignmentId=",assignmentId,"&workerId=",workerId,"&sessionId=",sessionId,"&time=",stringdate());				
					if(timeleft<=10  || timeleft>=1000)
					{ updatecallnumber=0
					}
					else if(updatecallnumber==0)
					{ updatecallnumber=1
					}
					else //updatecallnumber>=getfrenquence
					{ updatecallnumber=0
					}
					debug_isGetSend='YES';				
					
					document.getElementById('debug_isGetSend').value=debug_isGetSend;				
					$.get(url, "getFlag=true", 
					function(expconsensusAttributes) 
					{	var status = expconsensusAttributes["status"];
						if(status=="EG_NOT_RUNNING")
						{ alert('Sorry, the game has been stopped by the Administrator : you will be redirected to login');
							window.location='/eg/login';
						}
						var assignmentId = expconsensusAttributes["assignmentId"];
						var workerId = expconsensusAttributes["workerId"];
						var hitId = expconsensusAttributes["hitId"];
						var sessionId = expconsensusAttributes["sessionId"];
						var sound = expconsensusAttributes["sound"];
						var missingChoices = expconsensusAttributes["missingChoices"]; 
						var staticPath = expconsensusAttributes["staticPath"];
						var round = expconsensusAttributes["round"];
						game = expconsensusAttributes["game"];
						var position_or_value="{{EGParameters['position_or_value']}}"
						if(expconsensusAttributes["prevRoundHTML"]===undefined)
						{ expconsensusAttributes["prevRoundHTML"]='[[0],[0],[0]]'
						}
						var prevChoice = "";
						roundType = expconsensusAttributes["roundType"];
						var reward = expconsensusAttributes["reward"];
						var maxDecisionValue=expconsensusAttributes['maxDecisionValue']
						var imageType=expconsensusAttributes['imageType']
						var playMode=expconsensusAttributes['playMode']
							 
						//var imageurl = String(expconsensusAttributes["imageurl"]);
						var question = String(expconsensusAttributes["question"]);
						var displayerrorsize=expconsensusAttributes['displayerrorsize']
						var errorsize = expconsensusAttributes['errorsize']
						

						if(displayerrorsize=='y')
						{ $("#errorsizesentence").show()
							$("#errorsize").html(errorsize)
							$("#errorsize").show()
						}
						else
						{ $("#errorsizesentence").hide()
							$("#errorsize").hide()
						}
						//var isNewExpconsensusRound=expconsensusAttributes['isNewExpconsensusRound']        		
						question=question.split(",");
						//imageurl=imageurl.split(",");
						roundsentencebutton="<span class='black18'>Game "+game+"/{{EGParameters['numGames']}} - Round "+round;
						if(playMode=='discrete')
						{ roundsentencebutton=roundsentencebutton+" (You are playing for "+reward+" points)"
						}
						roundsentencebutton=roundsentencebutton+"</span>"
						$("#round").html(roundsentencebutton); 
						document.forms['expconsensus'].elements['roundNum'].value = round;
						var color= expconsensusAttributes["color"];
						if(expconsensusAttributes["imageType"]=='fractal')
						{ for(var i=1; i<=columnNumber;i++)
							{ $("#question"+i).html('<img height="20" width="100" src="'+staticPath+'pic/'+color[i-1]+'.png" alt='+staticPath+'pic/'+color[i-1]+'>');
							}
						}
						// Set the normal page
						var actionurl = "/eg/expconsensus";			
						actionurl = actionurl.concat("?hitId=",hitId,"&assignmentId=",assignmentId,"&workerId=",workerId,"&sessionId=",sessionId);			
						var mydecision = $('#expconsensus');
						mydecision.action = actionurl;
						var indexOfMyEstimations = [] ;
						if(game!=prevGame)
						{ var audioElement = document.createElement('audio');
							audioElement.setAttribute('src', staticPath+'pic/sound.mp3');
							audioElement.play();
							$("#prevRoundSentence1").html('')
							for(var i=0; i<=columnNumber;i++)
							{	$("#div_img_prevround"+(i+1)).hide()
								$("#td_prevRoundSentence"+(i+1)).css({"border-style":"none"});
								$("#td_zoom_prevround"+(i+1)).css({"border-style":"none"});
							}
														// td borders and content in lone rounds
							td_list=$("[id^='td_']");
							//alert(td_list.get(0).id)

							for(k=0;k<td_list.length;k++)
							{ td_list.eq(k).css({"border-style":"none"});
							}

							prevGame=game;
							var canvasImageToEvaluate = document.getElementById('canvasImageToEvaluate');
							var context = canvasImageToEvaluate.getContext('2d');
							var imageObj = new Image();
							imageObj.src = document.getElementById('gameset_pic_name').src;
							for(i=0;i<columnNumber;i++)
							{// draw cropped image
								var sourceX = imgsize*i;
								var sourceY = imgsize*(parseInt(game,10)-1);
								var sourceWidth = imgsize;
								var sourceHeight = imgsize;
								var destWidth = displayedimgsize;
								var destHeight = displayedimgsize;
								var destX = 0;
								var destY = 0;
								context.drawImage(imageObj, sourceX, sourceY, sourceWidth, sourceHeight, destX, destY, destWidth, destHeight);
								context.stroke();
								if(position_or_value=='position')
								{	context.beginPath();
									context.fillStyle = "rgb(127,127,127)";
									//leftWidth=coord_mouse.x;
									context.fillRect(0,0,(displayedimgsize*visibleimgpartsize),displayedimgsize);
									context.fillRect(displayedimgsize-(displayedimgsize*visibleimgpartsize),destY,displayedimgsize,displayedimgsize);
									context.stroke();
								}
								document.getElementById('image'+(i+1)).src=canvasImageToEvaluate.toDataURL();
							}
						}
	
						if(roundType=="LONE") 
						{	for(var k=0;k<$(".social").length;k++)
							{	$(".social").eq(k).hide();	
							}					
							$("#prevRoundSentence1").html('<img src="'+staticPath+'"pic/spacer.gif" width="1" height="60">')
							$("#prevRoundSentence2").html('');
							$("#estimationSentence").html('Your estimation'+(columnNumber>1?'s':'') +' (range '+minDecisionValue+' - '+maxDecisionValue+')');

							$("#td_prevRoundSentence").css({"border-style":"none"});
							for(var i=0;i<columnNumber;i++)
							{ $("#prevround"+(i+1)).html("");
								$("#div_img_prevround"+(i+1)).hide()
								$("#sortedListOfDecisions"+String(i+1)).html("");
								$("#td_zoom_prevround"+(i+1)).css({"border-style":"none"});
								$("#td_sortedListOfDecisions"+(i+1)).css({"border-style":"none"});
								$("#td_decision"+(i+1)).css({"border-style":"none"});
							}
														// td borders and content in lone rounds
							td_list=$("[id^='td_']");
							//alert(td_list.get(0).id)

							for(k=0;k<td_list.length;k++)
							{ td_list.eq(k).css({"border-style":"none"});
							}

						}
						else if(roundType == "SOCIAL")
						{	for(var k=0;k<$(".social").size();k++)
							{	$(".social").eq(k).css("display:table-row;");
								$(".social").eq(k).show();
							}
							for(var i=0; i<=columnNumber;i++)
							{	$("#div_img_prevround"+(i+1)).show()
							}
							$("#estimationSentence").html('Your new estimation'+(columnNumber>1?'s':'') +' (range '+minDecisionValue+' - '+maxDecisionValue+')');
							// td borders and content in social rounds
							td_list=$("[id^='td_']");
							//alert(td_list.get(0).id)

							for(k=0;k<td_list.length;k++)
							{ td_list.eq(k).css({"border-style":"solid","border-color":"#FFFFFF","border-width":"2px"});
							}
							
							if(position_or_value=='position')													
							{ $("#prevRoundSentence1").html('Estimations in the previous round <br>(<b>you in red</b>)')
							}
							else
							{ $("#prevRoundSentence1").html('You&nbsp;can&nbsp;zoom&nbsp;in&nbsp;by&nbsp;moving mouse<br>over the graphical graduated rule.<br><b>You in red</b>, others in blue')
							}
							$("#prevRoundSentence2").html('Estimations in the previous round <br>(<b>you in red</b>)');
							if(document.forms['expconsensus'].elements["zoomrunning"].value=='no')
							{	prevRoundHTML = JSON.parse(expconsensusAttributes["prevRoundHTML"]);
								prevChoice = expconsensusAttributes["prevChoice"];
								
								listOfEstimations = [];				    
								listOfEstimations[0] = prevRoundHTML[0].sort(function(a,b){return a-b});
								listOfEstimations[1] = prevRoundHTML[1].sort(function(a,b){return a-b});
								listOfEstimations[2] = prevRoundHTML[2].sort(function(a,b){return a-b});				    
								for(var j = 0; j<3; j++) 
								{ for(var i = listOfEstimations[j].length - 1; i >= 0; i--) 
									{ if(listOfEstimations[j][i] === prevChoice[j]) 
										{ listOfEstimations[j].splice(i, 1);						       
											indexOfMyEstimations[j] = i;
											break;
										}
									}
								}
								for(var j = 0; j<3; j++) 
								{ up = "";
									down = "&nbsp";
									if(indexOfMyEstimations[j]==0)
									{	up = up + '<button type="button" disabled style="color:red; padding-right:0px; padding-left:0px;">' + String(prevChoice[j]) + '</button>';     
									}
									for(var i=0 ; i<listOfEstimations[j].length; i++)
									{ if(listOfEstimations[j][i]!=0)
										{ up = up + '<button type="button" disabled style="color:blue; padding-right:0px; padding-left:0px;">' + String(listOfEstimations[j][i]) + '</button>';
										}
										if(i==indexOfMyEstimations[j]-1)
										{	up = up + '<button type="button" disabled style="color:red; padding-right:0px; padding-left:0px;">' + String(prevChoice[j]) + '</button>';     
										}
									}                  
									$("#sortedListOfDecisions"+String(j+1)).html(up);
								}
								canvas= document.getElementById("canvas");canvasZoom = document.getElementById("canvasZoom");
								if(expconsensusAttributes["prevRoundHTML"]!==undefined /*201411 && isDifferentFromPreviousEstimations(document.forms['expconsensus'].elements["savedPrevRoundHTML"].value,expconsensusAttributes["prevRoundHTML"])*/)
								{	
									listRoundValues=transformStringListRoundValues2Array(expconsensusAttributes["prevRoundHTML"])
									//alert(listRoundValues+' listRoundValues.length='+listRoundValues.length)
									document.forms['expconsensus'].elements["savedPrevRoundHTML"].value=expconsensusAttributes["prevRoundHTML"]
									gameId=game; roundId=round; distinct=''; xLabelFormat='';estimationPointSize=8
									imgRuleHeight=60;/*graduationRuleWidth=500;*/ zoom1=1;zoom2=graduationRuleWidthZoom/graduationRuleWidth; estimationPointSize=8; xMax=parseInt(maxDecisionValue,10)
									if(position_or_value=='position')
									{ graduationRuleWidth=displayedimgsize; 
									}
									if(playMode=='continuous')
									{	graduationStep1=1;graduationStep2=50;
									}
									if(imageType=='fractal')
									{ graduationStep1=10;graduationStep2=20;
										if(playMode=='continuous')
										{ graduationStep1=5;graduationStep2=50;
										}
										createRoundImages(canvas,listRoundValues,prevChoice,distinct,xMax,imgRuleHeight,graduationRuleWidth,zoom1,xLabelFormat,graduationStep1,graduationStep2,estimationPointSize) 
										graduationStep1=1;graduationStep2=5;distinct='z';
										if(playMode=='continuous')
										{ graduationStep1=1;graduationStep2=10;
										}
										createRoundImages(canvasZoom,listRoundValues,prevChoice,distinct,xMax,imgRuleHeight,graduationRuleWidth,zoom2,xLabelFormat,graduationStep1,graduationStep2,estimationPointSize) 
									}
									else if(imageType=='peanut')
									{	graduationStep1=50;graduationStep2=100;
										if(playMode=='continuous')
										{ graduationStep1=5;graduationStep2=50;
										}
										createRoundImages(canvas,listRoundValues,prevChoice,distinct,xMax,imgRuleHeight,graduationRuleWidth,zoom1,xLabelFormat,graduationStep1,graduationStep2,estimationPointSize) 
										graduationStep1=1;graduationStep2=10;distinct='z';
										if(playMode=='continuous')
										{ graduationStep1=1;graduationStep2=10;
										}
										createRoundImages(canvasZoom,listRoundValues,prevChoice,distinct,xMax,imgRuleHeight,graduationRuleWidth,zoom2,xLabelFormat,graduationStep1,graduationStep2,estimationPointSize) 
									}
								}
							}
						}
						 
						if(status=="CHOICE_MADE")
						{	$("#waiting").show();
							$("#killtime").show();
							//var timeleft = expconsensusAttributes['remainingTime'];
							timeleft = expconsensusAttributes['remainingTime'];
							var totalTime = expconsensusAttributes['totalTime'];	
							var timeleft_string;
							if(timeleft>1000 || timeleft<0)
							{	timeleft_string = 0;
							}
							else
							{	timeleft_string = timeleft;
							}
							$("#waiting").html("Waiting for answers from ".concat(missingChoices," more participants. <br><br>Time left : ", timeleft_string," / ",totalTime,"."));
							$("#playing").hide();
						}
						else if(status=="GAME_OVER")
						{	//alert("The game is over");
						}
						else if(status=="GAMESET_OVER")
						{	window.location.href="/eg/debriefing?hitId="+hitId+"&assignmentId="+assignmentId+"&workerId="+workerId+"&sessionId="+sessionId;
						}
						else if(status=="CHOICE_TO_BE_MADE")
						{	$("#waiting").hide();	    				
							$("#killtime").hide();        			
							$("#playing").show();
							//var timeleft = expconsensusAttributes['remainingTime'];
							remainingTimeServer=expconsensusAttributes['remainingTime'];
							timeleft = expconsensusAttributes['remainingTime'];
							var totalTime = expconsensusAttributes['totalTime'];	    					    				
							var timeleftnotbig = timeleft;
							if(timeleftnotbig>200)
							{	timeleftnotbig = 0;
							}
							// HERE	    				
							mydial(totalTime,timeleftnotbig);
														
							var completedTime = 100*(totalTime-timeleft)/totalTime;
							if(completedTime>100 || completedTime<0 || isNaN(completedTime))
							{	completedTime = 60;
							}
							if(timeleft<1000 && timeleft>=0)
							{	$("#remainingTimebox").show();
								$("#remainingTime").html(String(timeleft));
								$("#div_submit").hide();
							}
							
							if(timeleft<=10 && !(playMode=='continuous' && roundType == "SOCIAL"))
							{ if(timeleft%2==0)
								{ submit_color="#FF0000"
								}
								else
								{ submit_color="#000000"
								}
								document.getElementById("submit").style.color=submit_color
								$("#div_submit").show();
								document.getElementById("submit_now").style.color=submit_color
							}
							else
							{ document.getElementById("submit").style.color="#000000"
							}
							$("#auto").val(0);
						}    				    			
						//updatecallnumber=0
						document.getElementById('debug_updatecallnumber').value=updatecallnumber;				
						document.getElementById('debug_timeleft').value=timeleft;				
						document.getElementById('debug_remainingTimeServer').value=remainingTimeServer;				
						//document.getElementById('debugtextarea').value=document.getElementById('debugtextarea').value+'\n'+updatecallnumber+'  '+debug_isGetSend+' '+timeleft+'  '+remainingTimeServer
					},"json");// end of $.get(url,data="getFlag=true",function(expconsensusAttributes),format="json")

				}
			}// end of update function
			<!--  Post 3 fields even only 1 will be really used : currently required in order continuous mode works in wsgi -->
			var assignmentId = "{{ assignmentId }}";
			var workerId = "{{ workerId }}";
			var hitId = "{{ hitId }}";
			var sessionId = "{{ sessionId }}";
			function userSubmit()
			{ error=''
				for(var i=0;i<columnNumber;i++)
				{ if((isNaN($("#decision"+i).val()))) 
					{ error+="decision"+i+' is not a number '+$("#decision"+i).val();
					}
					else
					{ if($("#decision"+i).val()=='')
						{ error+="decision"+i+' is empty';
						}
						else
						{	if(parseFloat($("#decision"+i).val())<parseFloat(minDecisionValue) || parseFloat($("#decision"+i).val())>parseFloat(maxDecisionValue))
							{ error+="decision"+i+' must be greater than '+minDecisionValue+' and lower than '+maxDecisionValue;
							}
						}
					}
				}
				if(error!='')
				{ alert(error);
				  return false;
				}
				for(var i=0;i<3;i++)
				{ $("#auto"+i).val(0);
				}
				if($("#decision0").length)//field exists
				{ $("#decision0").focus();
				}
				
				if( playMode=="continuous" && roundType=="SOCIAL")
				{ ajaxsocial=true;
					/*var url = "/eg/expconsensus".concat("?hitId=",hitId,"&assignmentId=",assignmentId,"&workerId=",workerId,"&sessionId=",sessionId,"&time=",stringdate());				
					$.post(url,
						{ decision0 : $("#decision0").val(), auto0:$("#auto0").val(0),
							decision1 : $("#decision1").val(), auto1:$("#auto1").val(0),
							decision1 : $("#decision2").val(), auto2:$("#auto1").val(0)
						},
						function(expconsensusAttributes) 
						{$("#decision0").val('');$("#decision1").val(0);$("#decision2").val(0);
						}
					);*/
				}
				else
				{ ajaxsocial=true;
				}
				return true;
			}
			
			function isEven(n) 
			{	return isNumber(n) && (n % 2 == 0);
			}
			function isNumber(n)
			{ return n === parseFloat(n);
			}
		/*********************
		* Get things started *
		********************/
		
		</script>
		<style>
			#swatch 
			{	width: 120px;
				height: 100px;
				margin-top: 18px;
				margin-left: 350px;
				background-image: none;
			}
			.ui-progress 
			{	height: 60px;
			  border-radius: 60px;			  
			  box-shadow: inset 0px 1px 0px 0px #dbf383, inset 0px -1px 1px #58c43a;
			  border: 1px solid #4c8932;			  
			}
		</style>
	</head>
	<body>
  <!-- debug if needed for JS debug -->
  <div id="debug" style="display:none"><!-- -->
    <table><tr><td>isGetSend ?<input type="text" name="debug_isGetSend" id="debug_isGetSend" value=""></td>
		<td>updatecallnumber<input type="text" name="debug_updatecallnumber" id="debug_updatecallnumber" value=""></td>
    timeleft<input type="text" name="debug_timeleft" id="debug_timeleft" value="">
    remainingTimeServer<input type="text" name="debug_remainingTimeServer" id="debug_remainingTimeServer" value="">
    <!--gamenum<input type="text" name="debug_gamenum" id="debug_gamenum" value="">
    roundnum<input type="text" name="debug_roundnum" id="debug_roundnum" value=""> --><br>
    <tr><td colspan="2">debugtextarea<textarea name="debugtextarea" id="debugtextarea" cols="20" rows="5"></textarea></td></tr></table>
  </div>
  <!-- Here the createRoundImages function works : hidden but needed to draw something in canvas and then create images-->
  <div >
  	<canvas id="canvas" style="display:none"></canvas><!--  -->
  </div>
  <div>
  	<canvas id="canvasZoom" style="display:none"></canvas><!--  -->
  </div>
  <div ><!-- don't remove dimensions of canvasImageToEvaluate. We don't know why but the result of the cropped image in javascript is 200x150 !! -->
  	<canvas id="canvasImageToEvaluate" style="display:none"  width="{{ EGParameters['displayedimgsize'] }}" height="{{ EGParameters['displayedimgsize'] }}"></canvas><!--  -->
  </div>
  <div style="display:none" align="center"><img id="gameset_pic_name" src="../../static/pic/estimationPic/{{gameset_pic_name}}"></div>
  {% if EGParameters['position_or_value']=='position'%}
  partie visible : <input type="text" id="visibleimgpartsize" value="33" size="2" maxlength="2">%
  {% endif %}
	<div align="center">
    <div id="waiting" class="white14"></div>
    <div id="playing">
		<table border="0">
    	<tr>
      	<td>
      		<table align="center" cellspacing="0">
            <tr><td class="white18" align="center"><button align="center"><div id="round" style="text-align:center"></div></button>
            		</td>
            </tr>
            {% if EGParameters['site']=='eg_open'%}
            <tr><td align="center" nowrap>
                    <span id="errorsizesentence" class="orange16" style="display:none;">
                      During the 3 previous games, the average of the distances<br>of your answers to the true values was <span id="errorsize" class="red16" style="display:none;"></span></span>
                </td>
            </tr>
            {% endif %}
            <tr><td class="white18" align="center">{{question}}</td> </tr>
					</table>
        </td>
      </tr>
      <tr>
      	<td>
        	<table align="center" cellspacing="0">

            <tr>
              <td style="border:none;">          
              <form id="expconsensus" name="expconsensus" action="" method="post" autocomplete="off" onSubmit="return userSubmit()">
            <textarea name="savedPrevRoundHTML" class="black14" style="display:none"></textarea>
            </td>
              {% for numcolumn in range(1,columnNumber+1) %}
              <td  style="text-align:center;border-style:none;" class="white22" id="question{{numcolumn}}"></td>
              {% endfor %}
            </tr>
            <tr>
              <td align="center" style="border-style:solid; border-color:#FFFFFF;border-width: 2px;">
                <!-- hidden fields used to communicate with the zoom.js package which stops or starts refresh image estimation -->
                <input type="hidden" id="zoomrunning" name="zoomrunning" value="no">
                <!--  adjust zoom image width -->
                <input type="hidden" id="playmode" name="playmode" value="{{playMode}}">
                <div id="remainingTimebox" align="center" style="display:block">
                  <p class="white14" align="center"> Time left </p>
                  <input type="text" value=0 id="dial" data-thickness=".3" data-skin="tron" data-fgcolor="#000000" data-width="120">
                  <br>
                </div>
                <div id="div_submit" align="center" style="display:none;">
                   <class id="submit_now" style="font-size:16pt; color:#FF0000; font-weight:bold">Submit now !</class>
                </div>
              </td>
              {% for numcolumn in range(1,columnNumber+1) %}
              <td style="text-align:center;border-style:solid; border-color:#FFFFFF;border-width:2px;">
              	{% if EGParameters['position_or_value']=='position'%}
                	<input type="image" id="image{{numcolumn}}" src="" onMouseMove="redraw(event,this,{{numcolumn}})">
                {% else %}
                	<img id="image{{numcolumn}}" src="" >
              	{% endif %}
              </td>
              {% endfor %}
            </tr>
            {% if EGParameters['position_or_value']=='position'%}
            <script>
						function redraw(event,image, numcolumn)
						{ var canvasImageToEvaluate = document.getElementById('canvasImageToEvaluate');
							var context = canvasImageToEvaluate.getContext('2d');
							var imageObj = new Image();
							document.getElementById('debugtextarea').value=document.getElementById('debugtextarea').value+'\n'+game;
							visibleimgpartsize=document.getElementById('visibleimgpartsize').value/100;
							imageObj.src = document.getElementById('gameset_pic_name').src;
							i=numcolumn-1;
							// draw cropped image
							coord_mouse=posmouse(event,image);
							var sourceX = imgsize*i;
							var sourceY = imgsize*(parseInt(game,10)-1);
							var sourceWidth = imgsize;//;
							var sourceHeight = imgsize;
							var destX = 0;
							var destY = 0;
							var destWidth = displayedimgsize;
							var destHeight = displayedimgsize;
							context.drawImage(imageObj, sourceX, sourceY, sourceWidth, sourceHeight, destX, destY, destWidth, destHeight);
							context.stroke();
							context.beginPath();
							context.fillStyle = "rgb(127,127,127)";
							context.fillRect(0,0,Math.min(coord_mouse.x,displayedimgsize-(displayedimgsize*visibleimgpartsize)/2)-(displayedimgsize*visibleimgpartsize)/2,displayedimgsize);
							context.fillRect(Math.max(coord_mouse.x,(displayedimgsize*visibleimgpartsize)/2)+(displayedimgsize*visibleimgpartsize)/2,destY,displayedimgsize,displayedimgsize);
							context.stroke();
							context.stroke();
							document.getElementById('image'+(i+1)).src=canvasImageToEvaluate.toDataURL();
							// div cursor over graduation rule
							poscursor=Math.min(Math.max(coord_mouse.x,(displayedimgsize*visibleimgpartsize)/2),displayedimgsize-(displayedimgsize*visibleimgpartsize)/2);
							if(roundType!='LONE')
							{ div_img_prevround_pos=getOffset(document.getElementById('div_img_prevround'+numcolumn));
								div_cursorPosition=document.getElementById('div_cursorPosition'+numcolumn)
								div_cursorPosition.style.display='block';
								div_cursorPosition.style.position = "absolute";
								div_cursorPosition.style.left=div_img_prevround_pos.left+poscursor+'px';
								div_cursorPosition.style.top=div_img_prevround_pos.top+8+'px';
							}
							//createRoundImages(canvas,listRoundValues,prevChoice,distinct,xMax,imgRuleHeight,graduationRuleWidth,zoom1,xLabelFormat,graduationStep1,graduationStep2,estimationPointSize)
							/*document.getElementById('image'+(i+1)).height=imgsize*1.3;
							document.getElementById('image'+(i+1)).width=imgsize*1.3;*/
							document.getElementById('decision'+i).value=Math.round(poscursor*(imgsize/displayedimgsize));//
						}
						
						function getOffset(e) 
						{ var cx = 0;
							var cy = 0;
						
							while(e && !isNaN(e.offsetLeft) && !isNaN(e.offsetTop)) 
							{ cx += e.offsetLeft - e.scrollLeft;
								cy += e.offsetTop - e.scrollTop;
								e = e.offsetParent;
							}
							return { top: cy, left: cx };
						}
						
						function posmouse(event,element)
						{ e=event
							if(e.offsetX || e.offsetY) 
							{		x = e.pageX - getOffset(element).left - window.pageXOffset;//
									y = e.pageY - getOffset(element).top - window.pageYOffset;//
							}
							else if(e.layerX || e.layerY) {
									x = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft- getOffset(element).left - window.pageXOffset;//
									y = e.clientY + document.body.scrollTop + document.documentElement.scrollTop - getOffset(element).top - window.pageYOffset;//
							}
							return {x:x, y:y }
						} /**/  
						</script>
						{% endif %}
            <tr>
              <td id="td_prevRoundSentence" class="white14" style="{% if roundType=='LONE' %}border-style:none;{% else %} border-style:solid; border-color:#FFFFFF;border-width: 2px;{% endif %}"><span id="prevRoundSentence1"></span></td>
              {% for numcolumn in range(1,columnNumber+1) %}
              <td id="td_zoom_prevround{{numcolumn}}" style="text-align:center;{% if roundType=='LONE' %}border-style:none;{% else %} border-style:solid; border-color:#FFFFFF;border-width: 2px;{% endif %}">
              	<div id="div_img_prevround{{numcolumn}}" align="center" style="display:none;">
                	<img id="img_prevround{{numcolumn}}" src="" border="0" {% if EGParameters['position_or_value']!='position'%}class="cnxzoom"{% endif %}>
                </div>
                {% if EGParameters['position_or_value']=='position'%}
                	<div id="div_cursorPosition{{numcolumn}}" style="display:none">
                  	<img src="../../static/pic/cursor.png">
                  </div>
                {% endif %}
							</td>
              {% endfor %}
            </tr>
              {% if playMode=="continuous" %}
                <div id="div_img_prevround2" style="display:none"><img id="img_prevround2" style="display:none" src="" width="" height="" border="0" {% if EGParameters['position_or_value']!='position'%}class="cnxzoom"{% endif %}></div>
                <div id="div_img_prevround3" style="display:none"><img id="img_prevround3" style="display:none" src="" width="" height="" border="0" {% if EGParameters['position_or_value']!='position'%}class="cnxzoom"{% endif %}></div>
              {% endif %} 
            <tr>
              <td id="td_prevRoundSentence" style="{% if roundType=='LONE' %}border-style:none;{% else %} border-style:solid; border-color:#FFFFFF;border-width: 2px;{% endif %}"><span id="prevRoundSentence2" class="white14"></span></td>
              {% for numcolumn in range(1,columnNumber+1) %}
              <td id="td_sortedListOfDecisions{{numcolumn}}" style="text-align:center;{% if roundType=='LONE' %}border-style:none;{% else %} border-style:solid; border-color:#FFFFFF;border-width: 2px;{% endif %}"><div id="sortedListOfDecisions{{numcolumn}}"></div>
              </td>
              {% endfor %}
            </tr>
            
            {% if EGParameters['position_or_value']=='position'%}
              {% for numcolumn in range(0,columnNumber) %}
                <div style="display:none">
                  <input class="black14" type="text" id="decision{{numcolumn}}" name="decision{{numcolumn}}" max="{{maxDecisionValue}}" min="{{minDecisionValue}}" size="6">
                </div>
              {% endfor %}
              <!-- to change later : currently we send 3 decision fields in continuous mode even the first one is suffisant : necessary to work with wsgi which still works with 3 decisions -->
              {% if playMode=="continuous" %}
                <input type="hidden" id="decision1" name="decision1" value="0">
                <input type="hidden" id="decision2" name="decision2" value="0">
           		{% endif %} 
            {% else %}
            <tr>
              <td class="white14" style="border-style:solid; border-color:#FFFFFF;border-width: 2px;">
              	<div id="estimationSentence">
              	Your estimation{% if columnNumber>1 %}s{% endif %} range {{minDecisionValue}} - {{maxDecisionValue}}
                </div>
                </td>
              {% for numcolumn in range(0,columnNumber) %}
              <td style="text-align:center; border-style:solid; border-color:#FFFFFF;border-width: 2px;">
                <div style="display:block">
                  <input class="black14" type="text" id="decision{{numcolumn}}" name="decision{{numcolumn}}" max="{{maxDecisionValue}}" min="{{minDecisionValue}}" size="6">
                </div>
              </td>
              {% endfor %}
              <!-- to change later : currently we send 3 decision fields in continuous mode even the first one is suffisant : necessary to work with wsgi which still works with 3 decisions -->
              {% if playMode=="continuous" %}
                <input type="hidden" id="decision1" name="decision1" value="0">
                <input type="hidden" id="decision2" name="decision2" value="0">
           		{% endif %} 
            </tr>
           	{% endif %} 
            
            <tr>
              <td style="border:none;"></td>
              <td style="border:none; text-align:center" colspan="{{columnNumber}}">
               
                <input style="font-size:16pt; color:#000000" id="submit" type="{% if EGParameters['position_or_value']=='value'%}submit{% else %}hidden{% endif %}" value="Submit">
              
                <input type="hidden" name="roundNum" value="0">		
                <!-- to change later : currently we send 3 decision fields in continuous mode even the first one is suffisant : necessary to work with wsgi which still works with 3 decisions -->
                {% for numcolumn in range(0,3) %}
                <input type="hidden" id="auto{{numcolumn}}" name="auto{{numcolumn}}" value="0">
                {% endfor %}
              </form>
              </td> 
            </tr>
          </table>
        </td>
      </tr>
    </table>
				<span id="prevRoundSentence1"></span>
        {% for numcolumn in range(1,columnNumber+1) %}
				<!-- --><div id="div_img_prevround{{numcolumn}}z" style="display:none"><img id="img_prevround{{numcolumn}}z" src="" width="{{EGParameters['graduationRuleWidthZoom']}}" height="{{EGParameters['graduationRuleHeightZoom']}}"></div><!--<img src="" id="1" width="100" height="33" border="0" class="cnxzoom"> -->
        {% endfor %}
        {% if playMode=="continuous" %}
          <!-- --><div id="div_img_prevround2z" style="display:none"><img id="img_prevround2z" style="display:none" src="" width="{{EGParameters['graduationRuleWidthZoom']}}" height="{{EGParameters['graduationRuleHeightZoom']}}"></div><!--<img src="" id="1" width="100" height="33" border="0" class="cnxzoom"> -->
          <!-- --><div id="div_img_prevround3z" style="display:none"><img id="img_prevround3z" style="display:none" src="" width="{{EGParameters['graduationRuleWidthZoom']}}" height="{{EGParameters['graduationRuleHeightZoom']}}"></div><!--<img src="" id="1" width="100" height="33" border="0" class="cnxzoom"> -->
        {% endif %} 
			
    
		<!--<script type="text/javascript">
			var frmvalidator  = new Validator("expconsensus");
			for(var i=0;i<columnNumber;i++)
			{ frmvalidator.addValidation("decision"+i,"numeric","Numeric value only");        
				frmvalidator.addValidation("decision"+i,"req");        
				frmvalidator.addValidation("decision"+i,"lt={{EGParameters['maxDecisionValue']}}+1","Value must be smaller than {{EGParameters['maxDecisionValue']}}");
				frmvalidator.addValidation("decision"+i,"gt={{EGParameters['minDecisionValue']}}-1","Value must be greater than {{EGParameters['minDecisionValue']}}");
			}
		</script> -->
    </div>
    
    <div id="killtime" style="display:none;" align="center" class="white14">
    	<p>You can kill mosquitos while waiting for the next round...</p>
      <p>&nbsp;</p><p></p>
        <object id="FlashID" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="700" height="400">
          <param name="movie" value="../../static/kill.swf">
          <param name="quality" value="high">
          <param name="wmode" value="opaque">
          <param name="swfversion" value="6.0.65.0">
          <object type="application/x-shockwave-flash" data="../../static/kill.swf" width="700" height="400">
            <param name="quality" value="high">
            <param name="wmode" value="opaque">
            <param name="swfversion" value="6.0.65.0">
          </object>
        </object>
    </div>
</div>
	</body>
</html>
